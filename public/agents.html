<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS1 Agent Monitor</title>
    <link rel="stylesheet" href="css/bulma.css">
    <link rel="stylesheet" href="css/overrides.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <nav id="sidebar-container"></nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="level mb-5">
            <div class="level-left">
                <div class="level-item">
                    <div>
                        <h1 class="title is-3">Agent Network Status</h1>
                        <p class="subtitle is-6 has-text-grey">Real-time monitoring of autonomous agents</p>
                    </div>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <span class="tag is-success is-medium">Live Monitoring</span>
                </div>
            </div>
        </div>

        <div class="columns">
            <!-- Agent List (Sidebar) -->
            <div class="column is-one-third">
                <nav class="panel is-info">
                    <p class="panel-heading">
                        Agents
                    </p>
                    <div id="agentList">
                        <div class="panel-block has-text-grey-light is-italic">
                            Loading agents...
                        </div>
                    </div>
                </nav>
            </div>

            <!-- Agent Details -->
            <div class="column">
                <div id="agentDetails">
                    <div class="card">
                        <div class="card-content has-text-centered">
                            <p class="has-text-grey is-size-5">Select an agent to view details</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="sidebar.js"></script>
    <script>
        let agents = [];
        let logs = [];
        let selectedAgentId = null;

        // Fetch Data
        async function fetchData() {
            const list = document.getElementById('agentList');
            if (agents.length === 0) {
                list.innerHTML = '<div class="panel-block has-text-grey-light is-italic"><span class="icon mr-2"><i class="fas fa-spinner fa-pulse"></i></span> Loading agents...</div>';
            }

            try {
                const [agentsRes, logsRes] = await Promise.all([
                    fetch('/api/agents?t=' + Date.now()),
                    fetch('/api/logs?t=' + Date.now())
                ]);
                
                if (!agentsRes.ok) throw new Error("Failed to fetch agents");
                if (!logsRes.ok) throw new Error("Failed to fetch logs");

                agents = await agentsRes.json();
                logs = await logsRes.json();
                
                // console.log('Fetched Agents:', agents); // Debug log

                renderSidebar();
                
                // Handle Deep Linking (Rule 2)
                const hash = window.location.hash.substring(1);
                if (hash && agents.find(a => a.id === hash)) {
                    if (selectedAgentId !== hash) {
                        selectAgent(hash);
                    } else {
                        renderDetails(selectedAgentId); // Just refresh details
                    }
                } else if (selectedAgentId) {
                    renderDetails(selectedAgentId);
                } else if (agents.length > 0) {
                    selectAgent(agents[0].id);
                }
            } catch (e) {
                console.error("Failed to fetch data", e);
                list.innerHTML = `<div class="panel-block has-text-danger"><span class="icon mr-2"><i class="fas fa-exclamation-circle"></i></span> Error: ${e.message}</div>`;
            }
        }

        function getModeColor(mode) {
            switch(mode) {
                case 'live': return 'is-danger';
                case 'mock': return 'is-warning';
                case 'simulation': return 'is-info';
                default: return 'is-light';
            }
        }

        function getModeLabel(mode) {
            switch(mode) {
                case 'live': return 'Live (Real API Calls)';
                case 'mock': return 'Mock (Fake Data)';
                case 'simulation': return 'Simulation (System Logic)';
                default: return 'Unknown';
            }
        }

        function renderSidebar() {
            const list = document.getElementById('agentList');
            list.innerHTML = agents.map(agent => `
                <a class="panel-block ${selectedAgentId === agent.id ? 'is-active has-background-white-ter has-text-weight-bold' : ''}" onclick="selectAgent('${agent.id}')">
                    <span class="panel-icon">
                        <i class="fas fa-robot" aria-hidden="true"></i>
                    </span>
                    <div style="width: 100%;">
                        <div class="is-flex is-justify-content-space-between">
                            <span>${agent.name}</span>
                            <div>
                                <span class="tag ${agent.status === 'active' ? 'is-success' : 'is-light'} is-small mr-1">${agent.status === 'active' ? 'ACTIVE' : 'OFF'}</span>
                                <span class="tag ${getModeColor(agent.mode)} is-small">${agent.mode ? agent.mode.toUpperCase() : 'UNKNOWN'}</span>
                            </div>
                        </div>
                    </div>
                </a>
            `).join('');
        }

        function selectAgent(id) {
            selectedAgentId = id;
            // Update URL hash (Rule 2)
            if (window.location.hash.substring(1) !== id) {
                window.history.replaceState(null, null, '#' + id);
            }
            renderSidebar();
            renderDetails(id);
        }

        function renderDetails(id) {
            const agent = agents.find(a => a.id === id);
            if (!agent) return;

            const container = document.getElementById('agentDetails');
            
            // Filter logs logic
            const agentLogs = logs.filter(l => 
                l.agent === agent.name || 
                l.agent === agent.id ||
                (agent.id === 'product_research_agent' && l.agent === 'ProductResearcher') ||
                (agent.id === 'supplier_agent' && l.agent === 'SupplierManager') ||
                (agent.id === 'store_build_agent' && l.agent === 'StoreBuilder') ||
                (agent.id === 'marketing_agent' && l.agent === 'Marketer') ||
                (agent.id === 'operations_agent' && l.agent === 'Operations') ||
                (agent.id === 'analytics_agent' && l.agent === 'Analytics') ||
                (agent.id === 'ceo_agent' && l.agent === 'CEO') ||
                (agent.id === 'customer_service_agent' && l.agent === 'CustomerService')
            );

            container.innerHTML = `
                <div class="card mb-5">
                    <header class="card-header">
                        <p class="card-header-title is-size-4">
                            ${agent.name}
                        </p>
                        <div class="card-header-icon">
                            <span class="tag ${agent.status === 'active' ? 'is-success' : 'is-light'} is-medium mr-2">${agent.status === 'active' ? 'ACTIVE' : 'OFFLINE'}</span>
                            <span class="tag ${getModeColor(agent.mode)} is-medium">${agent.mode ? agent.mode.toUpperCase() : 'UNKNOWN'}</span>
                        </div>
                    </header>
                    <div class="card-content">
                        <div class="content">
                            <p><strong>Status:</strong> <span class="has-text-success">Active</span></p>
                            <p><strong>Mode:</strong> ${getModeLabel(agent.mode)}</p>
                            <p><strong>Last Active:</strong> ${new Date().toLocaleTimeString()}</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <header class="card-header">
                        <p class="card-header-title">
                            Recent Activity Log
                        </p>
                    </header>
                    <div class="card-content">
                        <div class="content">
                            ${agentLogs.length > 0 ? `
                                <div class="table-container">
                                    <table class="table is-fullwidth is-striped is-hoverable is-narrow">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Message</th>
                                                <th>Data</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${agentLogs.reverse().slice(0, 50).map(log => `
                                                <tr>
                                                    <td class="is-size-7" style="white-space: nowrap;">${new Date(log.timestamp).toLocaleTimeString()}</td>
                                                    <td>
                                                        <div style="max-height: 100px; overflow-y: auto; word-break: break-word;">${log.message}</div>
                                                    </td>
                                                    <td style="width: 40%;">
                                                        ${log.data ? `<pre class="is-size-7 p-1" style="max-height: 200px; overflow: auto; white-space: pre-wrap;">${JSON.stringify(log.data, null, 2)}</pre>` : '-'}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p class="has-text-grey has-text-centered py-4">No recent logs found for this agent.</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // Initial Load
        fetchData();
        // Poll every 3 seconds
        setInterval(fetchData, 3000);

        // Initialize Sidebar
        if (window.initSidebar) window.initSidebar();
    </script>
</body>
</html>
