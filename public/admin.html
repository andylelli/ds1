<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS1 Control Panel</title>
    <link rel="stylesheet" href="css/bulma.css">
    <link rel="stylesheet" href="css/overrides.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <!-- Sidebar -->
    <nav id="sidebar-container"></nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- SIMULATION -->
        <div id="simulation" class="tab-content is-hidden">
            <div class="level mb-5">
                <div class="level-left">
                    <div class="level-item">
                        <h1 class="title is-3">Simulation Control</h1>
                    </div>
                </div>
            </div>
            
            <div class="columns">
                <!-- Simulation Control & Logs -->
                <div class="column is-full">
                    <div class="card mb-5">
                        <div class="card-content">
                            <div class="level">
                                <div class="level-left">
                                    <div>
                                        <h2 class="title is-5">Run Simulation</h2>
                                        <p class="subtitle is-6 has-text-grey">Trigger a full end-to-end product lifecycle simulation.</p>
                                    </div>
                                </div>
                                <div class="level-right">
                                    <div class="tags has-addons mr-4">
                                        <span class="tag is-dark">STATUS</span>
                                        <span id="simStatus" class="tag is-light">STOPPED</span>
                                    </div>
                                    <div class="box has-background-black has-text-green p-2" style="border: 1px solid #00d1b2; min-width: 150px;">
                                        <div class="has-text-centered">
                                            <div id="simClock" class="is-size-5 has-text-weight-bold" style="font-family: monospace; color: #00d1b2;">08:00</div>
                                            <div id="simDay" class="is-size-7 has-text-weight-bold" style="font-family: monospace; color: #00d1b2;">Day 1</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="field has-addons mb-4">
                                <div class="control is-expanded">
                                    <input class="input" type="text" id="simProductInput" placeholder="Ask CEO to find a product (e.g., 'Eco-friendly dog toys', 'Smart home gadgets')...">
                                </div>
                                <div class="control">
                                    <button id="btnStart" class="button is-primary" onclick="startSimulation()">
                                        <span class="icon"><i class="fas fa-play"></i></span>
                                        <span>Start</span>
                                    </button>
                                    <button id="btnPause" class="button is-warning is-hidden" onclick="pauseSimulation()">
                                        <span class="icon"><i class="fas fa-pause"></i></span>
                                        <span>Pause</span>
                                    </button>
                                    <button id="btnResume" class="button is-success is-hidden" onclick="resumeSimulation()">
                                        <span class="icon"><i class="fas fa-play"></i></span>
                                        <span>Resume</span>
                                    </button>
                                    <button id="btnStop" class="button is-danger is-hidden" onclick="stopSimulation()">
                                        <span class="icon"><i class="fas fa-stop"></i></span>
                                        <span>Stop</span>
                                    </button>
                                </div>
                            </div>

                            <div class="buttons">
                                <button class="button is-small" onclick="clearSimulationDb()">
                                    <span class="icon"><i class="fas fa-trash"></i></span>
                                    <span>Clear Sim DB</span>
                                </button>
                                <button class="button is-small" onclick="clearLogDisplay()">
                                    <span class="icon"><i class="fas fa-broom"></i></span>
                                    <span>Clear Logs</span>
                                </button>
                                <button class="button is-small" onclick="showAllLogs()">
                                    <span class="icon"><i class="fas fa-scroll"></i></span>
                                    <span>Show History</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-content" style="padding: 0;">
                            <div class="has-background-black-ter p-3" style="border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                                <h2 class="title is-6 has-text-light m-0">SYSTEM LOGS</h2>
                                <span class="tag is-dark">LIVE</span>
                            </div>
                            <div id="logViewer" class="box has-background-black has-text-light" style="height: 600px; overflow-y: auto; overflow-x: hidden; word-break: break-word; white-space: normal; font-family: 'Consolas', 'Monaco', monospace; border-radius: 0; border: none; padding: 1rem;">
                                <div class="has-text-grey">System initialized. Waiting for data stream...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CEO CHAT -->
        <div id="ceo-chat" class="tab-content is-hidden">
            <div class="level mb-5">
                <div class="level-left">
                    <div class="level-item">
                        <div>
                            <h1 class="title is-3 mb-2">Chat with CEO</h1>
                            <p class="subtitle is-6 has-text-grey">Direct line to the Chief Executive Agent</p>
                        </div>
                    </div>
                    <div class="level-item">
                        <span id="ceoModeBadge" class="tag is-light">Loading...</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    <div id="chatHistory" class="box" style="height: 500px; overflow-y: auto; background-color: #f5f7fa;">
                        <div class="chat-message ceo">
                            <div class="has-text-weight-bold mb-1">CEO Agent</div>
                            Hello. I am ready to discuss business strategy, approve products, or review performance metrics. How can I assist you today?
                        </div>
                    </div>
                    <div class="field has-addons">
                        <div class="control is-expanded">
                            <input class="input" type="text" id="ceoChatInput" placeholder="Type your message here..." onkeypress="handleChatKey(event)">
                        </div>
                        <div class="control">
                            <button class="button is-primary" onclick="sendCeoMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRODUCTS -->
        <div id="products" class="tab-content is-hidden">
            <div class="level mb-5">
                <div class="level-left">
                    <div class="level-item">
                        <h1 class="title is-3">Winning Products</h1>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <button class="button" onclick="fetchProducts()">
                            <span class="icon"><i class="fas fa-sync"></i></span>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-content">
                    <div id="productsList" class="table-container">Loading...</div>
                </div>
            </div>
        </div>

        <!-- ORDERS -->
        <div id="orders" class="tab-content is-hidden">
            <div class="level mb-5">
                <div class="level-left">
                    <div class="level-item">
                        <h1 class="title is-3">Order History</h1>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <button class="button" onclick="fetchOrders()">
                            <span class="icon"><i class="fas fa-sync"></i></span>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-content">
                    <div id="ordersList" class="table-container">Loading...</div>
                </div>
            </div>
        </div>

        <!-- ADS -->
        <div id="ads" class="tab-content is-hidden">
            <div class="level mb-5">
                <div class="level-left">
                    <div class="level-item">
                        <h1 class="title is-3">Ad Campaigns</h1>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item">
                        <button class="button" onclick="fetchAds()">
                            <span class="icon"><i class="fas fa-sync"></i></span>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-content">
                    <div id="adsList" class="table-container">
                        <p class="has-text-centered has-text-grey p-6">No active ad campaigns found.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- SETTINGS -->
        <div id="settings" class="tab-content is-hidden">
            <div class="level mb-5">
                <div class="level-left">
                    <div class="level-item">
                        <h1 class="title is-3">System Settings</h1>
                    </div>
                </div>
            </div>
            <div class="columns">
                <div class="column is-half">
                    <div class="card">
                        <div class="card-content">
                            <h2 class="title is-5">Environment Configuration</h2>
                            
                            <div class="field">
                                <label class="label" for="dbMode">Database Mode</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select id="dbMode">
                                            <option value="test">Test (PostgreSQL Simulator Database)</option>
                                            <option value="live">Live (PostgreSQL Production Database)</option>
                                        </select>
                                    </div>
                                </div>
                                <p class="help">Select which database the system should use for operations.</p>
                            </div>
                            
                            <div class="field mt-4">
                                <label class="label" for="logLevel">Log Level</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select id="logLevel">
                                            <option value="debug">Debug (Verbose)</option>
                                            <option value="info">Info (Standard)</option>
                                            <option value="warn">Warning</option>
                                            <option value="error">Error Only</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="field mt-5">
                                <div class="control">
                                    <button class="button is-primary" onclick="saveConfig()">
                                        <span class="icon"><i class="fas fa-save"></i></span>
                                        <span>Save & Apply Changes</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DATABASE -->
        <div id="database" class="tab-content is-hidden">
            <div class="level mb-5">
                <div class="level-left">
                    <div class="level-item">
                        <h1 class="title is-3">Database Inspector</h1>
                    </div>
                </div>
            </div>
            
            <!-- Docker Status Card -->
            <div class="card mb-5">
                <div class="card-content">
                    <h2 class="title is-5">PostgreSQL Database Container</h2>
                    
                    <div class="box has-background-white-ter">
                        <div class="level">
                            <div class="level-left">
                                <div class="level-item">
                                    <span id="dbStatusIndicator" class="tag is-light mr-2"></span>
                                    <span id="dbStatusText" class="has-text-weight-bold has-text-grey">Checking...</span>
                                </div>
                            </div>
                            <div class="level-right">
                                <div class="level-item">
                                    <div class="buttons">
                                        <button class="button is-small" onclick="startDocker()">
                                            <span class="icon is-small"><i class="fas fa-play"></i></span>
                                            <span>Start</span>
                                        </button>
                                        <button class="button is-small" onclick="stopDocker()">
                                            <span class="icon is-small"><i class="fas fa-stop"></i></span>
                                            <span>Stop</span>
                                        </button>
                                        <button class="button is-small" onclick="checkDockerStatus()">
                                            <span class="icon is-small"><i class="fas fa-sync"></i></span>
                                            <span>Refresh</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="is-size-7 has-text-grey pt-2" style="border-top: 1px solid #dbdbdb;">
                            <strong>Databases:</strong> dropship (Live), dropship_sim (Simulator)
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-content">
                    <div class="columns is-multiline mb-4">
                        <div class="column is-one-quarter">
                            <div class="field">
                                <label class="label">Source</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select id="dbSelector" onchange="fetchDbTopics(); fetchDbData()">
                                            <option value="live">Live Database</option>
                                            <option value="sim">Simulator Database</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column is-one-quarter">
                            <div class="field">
                                <label class="label">Table</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select id="dbTableSelector" onchange="handleTableChange()">
                                            <option value="events">Events</option>
                                            <option value="products">Products</option>
                                            <option value="orders">Orders</option>
                                            <option value="ads">Ads</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column is-one-quarter">
                            <div class="field">
                                <label class="label">Topic Filter</label>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select id="dbTopicFilter" onchange="fetchDbData()">
                                            <option value="">All Topics</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="column is-one-quarter">
                            <div class="field">
                                <label class="label">&nbsp;</label>
                                <div class="control">
                                    <button class="button is-fullwidth" onclick="fetchDbData()">
                                        <span class="icon"><i class="fas fa-sync"></i></span>
                                        <span>Refresh Data</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="dbEventsList" class="table-container">Loading...</div>
                </div>
            </div>
        </div>

    </main>

    <div id="statusMessage" class="notification is-hidden" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;"></div>

    <script src="sidebar.js"></script>
    <script>
        let logInterval = null;
        let logStartTime = 0;
        let currentMode = 'simulation'; // Default

        // --- Navigation ---
        function switchTab(tabId) {
            // Access Control
            if (tabId === 'simulation' && currentMode !== 'simulation') {
                console.warn('Access denied to simulation tab in live mode');
                switchTab('products');
                return;
            }

            // Update Content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('is-hidden'));
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.classList.remove('is-hidden');
            }

            // Handle Simulation Logs
            if (tabId === 'simulation') {
                fetchLogs();
                updateClock();
                if (!logInterval) logInterval = setInterval(() => {
                    fetchLogs();
                    updateClock();
                }, 1000); // Faster refresh for clock (1s)
            } else {
                if (logInterval) {
                    clearInterval(logInterval);
                    logInterval = null;
                }
            }

            // Auto-refresh data
            if (tabId === 'products') fetchProducts();
            if (tabId === 'orders') fetchOrders();
            if (tabId === 'ads') fetchAds();
            if (tabId === 'database') { checkDockerStatus(); fetchDbTopics(); fetchDbData(); }
            if (tabId === 'ceo-chat') setTimeout(() => document.getElementById('ceoChatInput').focus(), 100);
        }

        // Handle initial hash
        window.addEventListener('load', () => {
            // loadConfig will handle the initial tab switch based on mode
        });

        // --- Simulation & Logs ---
        function clearLogDisplay() {
            logStartTime = Date.now();
            fetchLogs();
            showStatus('Log display cleared.', 'success');
        }

        function showAllLogs() {
            logStartTime = 0;
            fetchLogs();
            showStatus('Showing full history.', 'success');
        }

        function updateSimControls(state) {
            const btnStart = document.getElementById('btnStart');
            const btnPause = document.getElementById('btnPause');
            const btnResume = document.getElementById('btnResume');
            const btnStop = document.getElementById('btnStop');
            const status = document.getElementById('simStatus');
            const input = document.getElementById('simProductInput');

            // Reset all
            btnStart.classList.add('is-hidden');
            btnPause.classList.add('is-hidden');
            btnResume.classList.add('is-hidden');
            btnStop.classList.add('is-hidden');
            input.disabled = false;

            if (state === 'running') {
                btnPause.classList.remove('is-hidden');
                btnStop.classList.remove('is-hidden');
                status.textContent = 'RUNNING';
                status.className = 'tag is-success';
                input.disabled = true;
            } else if (state === 'paused') {
                btnResume.classList.remove('is-hidden');
                btnStop.classList.remove('is-hidden');
                status.textContent = 'PAUSED';
                status.className = 'tag is-warning';
                input.disabled = true;
            } else { // stopped
                btnStart.classList.remove('is-hidden');
                status.textContent = 'STOPPED';
                status.className = 'tag is-light';
                input.disabled = false;
            }
        }

        async function startSimulation() {
            const query = document.getElementById('simProductInput').value.trim();
            if (!query) {
                showStatus('Please enter a product idea or category.', 'warning');
                document.getElementById('simProductInput').focus();
                return;
            }

            const btnStart = document.getElementById('btnStart');
            btnStart.classList.add('is-loading');

            try {
                logStartTime = Date.now() - 2000;
                
                // 1. Start Research Phase
                const res1 = await fetch('/api/simulation/start', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category: query })
                });
                
                // 2. Start Loop Automatically
                const res2 = await fetch('/api/simulation/loop/start', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interval: 5000 }) // 5s default
                });

                if (res1.ok && res2.ok) {
                    showStatus('Simulation started successfully.', 'success');
                    updateSimControls('running');
                    fetchLogs();
                } else {
                    showStatus('Failed to start simulation fully.', 'error');
                }
            } catch (e) {
                showStatus('Failed to start simulation.', 'error');
                console.error(e);
            } finally {
                btnStart.classList.remove('is-loading');
            }
        }

        async function pauseSimulation() {
            try {
                await fetch('/api/simulation/loop/stop', { method: 'POST' });
                updateSimControls('paused');
                showStatus('Simulation paused.', 'warning');
            } catch (e) { showStatus('Failed to pause.', 'error'); }
        }

        async function resumeSimulation() {
            try {
                await fetch('/api/simulation/loop/start', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interval: 5000 })
                });
                updateSimControls('running');
                showStatus('Simulation resumed.', 'success');
            } catch (e) { showStatus('Failed to resume.', 'error'); }
        }

        async function stopSimulation() {
            if (!confirm('Stop simulation? This will halt the clock.')) return;
            try {
                await fetch('/api/simulation/loop/stop', { method: 'POST' });
                updateSimControls('stopped');
                showStatus('Simulation stopped.', 'info');
            } catch (e) { showStatus('Failed to stop.', 'error'); }
        }
        
        async function updateClock() {
            try {
                const res = await fetch('/api/simulation/status');
                if (!res.ok) {
                    console.error('Clock API failed:', res.status, res.statusText);
                    return;
                }
                const data = await res.json();
                // console.log('Clock Data from API:', data); // Debug

                // Sync UI state with server state
                if (data.isRunning) {
                     updateSimControls('running');
                } else if (data.tickCount > 0) {
                     updateSimControls('paused');
                } else {
                     updateSimControls('stopped');
                }

                if (data.tickCount !== undefined) {
                    // 1 tick = 2 hours
                    // Start Date: Jan 1, 2025 08:00
                    const start = new Date('2025-01-01T08:00:00');
                    const current = new Date(start.getTime() + (data.tickCount * 2 * 60 * 60 * 1000));
                    
                    const timeStr = current.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                    const dayStr = `Day ${Math.floor(data.tickCount / 12) + 1}`; // 12 ticks per day
                    
                    document.getElementById('simClock').textContent = timeStr;
                    document.getElementById('simDay').textContent = dayStr;
                }
            } catch (e) {
                console.error('Clock update error:', e);
            }
        }

        // Legacy loop functions removed/merged into main controls
        // async function startLoop() { ... }
        // async function stopLoop() { ... }

        async function clearSimulationDb() {
            if (!confirm('Are you sure you want to clear all simulation database data (products, orders, campaigns, logs)?')) {
                return;
            }
            try {
                // Stop loop first if running
                await fetch('/api/simulation/loop/stop', { method: 'POST' });
                updateSimControls('stopped');

                const res = await fetch('/api/simulation/clear', { method: 'POST' });
                const data = await res.json();
                showStatus(data.message, 'success');
                
                // Clear UI immediately
                document.getElementById('logViewer').innerHTML = '<div class="has-text-grey-light is-italic">Logs cleared...</div>';
                document.getElementById('simClock').textContent = '08:00';
                document.getElementById('simDay').textContent = 'Day 1';
                
                // Reset Clock immediately (fetch from server to confirm)
                await updateClock();
                
                // Refresh logs (should be empty)
                await fetchLogs();
            } catch (e) {
                showStatus('Failed to clear simulation database.', 'error');
                console.error('Clear simulation error:', e);
            }
        }

        async function fetchLogs() {
            try {
                const res = await fetch('/api/logs');
                const logs = await res.json();
                const filteredLogs = logs.filter(log => new Date(log.timestamp).getTime() >= logStartTime);
                const viewer = document.getElementById('logViewer');
                
                if (filteredLogs.length === 0) {
                    // Don't clear if we are just waiting for more
                    if (viewer.innerHTML === 'Waiting for logs...') {
                         viewer.innerHTML = `<div class="p-4 has-text-grey">No new logs...</div>`;
                    }
                    return;
                }

                // Remember scroll state
                const oldScrollHeight = viewer.scrollHeight;
                const oldScrollTop = viewer.scrollTop;
                const wasAtTop = oldScrollTop < 50;
                
                // Game-style log rendering
                const html = filteredLogs.map(log => {
                    let colorClass = 'has-text-light';
                    let icon = '<i class="fas fa-info-circle mr-1"></i>'; // Default icon
                    
                    if (log.agent === 'System') {
                        colorClass = 'has-text-grey-light';
                        icon = '<i class="fas fa-cog mr-1"></i>';
                        if (log.message.includes('Tick')) {
                            colorClass = 'has-text-grey-light is-size-7'; // Dim ticks
                            icon = '<i class="fas fa-clock mr-1" style="font-size: 0.8em;"></i>';
                        }
                    } else if (log.agent === 'Marketing' || log.agent === 'Marketer') {
                        colorClass = 'has-text-info';
                        icon = '<i class="fas fa-bullhorn mr-1"></i>';
                    } else if (log.agent === 'Supplier') {
                        colorClass = 'has-text-warning';
                        icon = '<i class="fas fa-truck mr-1"></i>';
                    } else if (log.agent === 'Analytics') {
                        colorClass = 'has-text-primary';
                        icon = '<i class="fas fa-chart-line mr-1"></i>';
                    } else if (log.agent === 'Research') {
                        colorClass = 'has-text-link';
                        icon = '<i class="fas fa-search mr-1"></i>';
                    } else if (log.agent === 'Store') {
                        colorClass = 'has-text-success';
                        icon = '<i class="fas fa-store mr-1"></i>';
                    } else if (log.agent === 'CEO') {
                        colorClass = 'has-text-white has-text-weight-bold';
                        icon = '<i class="fas fa-user-tie mr-1"></i>';
                    }
                    
                    // Override for orders
                    if (log.message.includes('orders') && !log.message.includes('0 orders')) {
                        colorClass = 'has-text-success has-text-weight-bold';
                        icon = '<i class="fas fa-dollar-sign mr-1"></i>';
                    }

                    return `
                    <div class="mb-1" style="line-height: 1.4;">
                        <span class="has-text-grey-dark is-size-7 is-family-monospace mr-2">[${new Date(log.timestamp).toLocaleTimeString([], {hour12: false})}]</span>
                        <span class="${colorClass}">
                            ${icon}
                            <span class="has-text-weight-bold mr-1">${log.agent}:</span>
                            ${log.message}
                        </span>
                        ${log.data && Object.keys(log.data).length > 0 ? `<div class="has-text-grey is-size-7 ml-4 pl-2" style="border-left: 2px solid #333;">${JSON.stringify(log.data)}</div>` : ''}
                    </div>`;
                }).join('');
                
                viewer.innerHTML = html;
                
                // Smart scroll: If at top, stay at top. If scrolled down, maintain relative position.
                if (wasAtTop) {
                    viewer.scrollTop = 0;
                } else {
                    const newScrollHeight = viewer.scrollHeight;
                    viewer.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);
                }
            } catch (e) { console.error("Log fetch failed", e); }
        }

        // --- Data Fetching ---
        async function fetchProducts() {
            const list = document.getElementById('productsList');
            try {
                const res = await fetch('/api/products');
                const products = await res.json();
                if (products.length === 0) { list.innerHTML = '<p class="has-text-centered has-text-grey p-4">No products found.</p>'; return; }

                let html = `<table class="table is-fullwidth is-striped is-hoverable"><thead><tr><th>Name</th><th>Potential</th><th>Margin</th><th>Found At</th></tr></thead><tbody>`;
                products.forEach(p => {
                    html += `<tr>
                        <td><strong>${p.name}</strong></td>
                        <td><span class="tag is-success">${p.potential}</span></td>
                        <td>${p.margin}</td>
                        <td>${new Date(p.timestamp).toLocaleString()}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (e) { list.innerHTML = `<p class="has-text-danger">Error: ${e.message}</p>`; }
        }

        async function fetchOrders() {
            const list = document.getElementById('ordersList');
            try {
                const res = await fetch('/api/orders');
                const orders = await res.json();
                if (orders.length === 0) { list.innerHTML = '<p class="has-text-centered has-text-grey p-4">No orders found.</p>'; return; }

                let html = `<table class="table is-fullwidth is-striped is-hoverable"><thead><tr><th>Order ID</th><th>Product</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead><tbody>`;
                orders.forEach(o => {
                    const badgeClass = o.status === 'shipped' ? 'is-info' : 'is-warning';
                    html += `<tr>
                        <td>${o.id}</td>
                        <td>${o.product}</td>
                        <td>$${o.amount}</td>
                        <td><span class="tag ${badgeClass}">${o.status}</span></td>
                        <td>${new Date(o.timestamp).toLocaleString()}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (e) { list.innerHTML = `<p class="has-text-danger">Error: ${e.message}</p>`; }
        }

        async function fetchAds() {
            const list = document.getElementById('adsList');
            try {
                const res = await fetch('/api/ads');
                const ads = await res.json();
                if (ads.length === 0) { list.innerHTML = '<p class="has-text-centered has-text-grey p-4">No active ad campaigns found.</p>'; return; }

                let html = `<table class="table is-fullwidth is-striped is-hoverable"><thead><tr><th>Platform</th><th>Product</th><th>Budget</th><th>Status</th><th>Date</th></tr></thead><tbody>`;
                ads.forEach(a => {
                    const badgeClass = a.status === 'active' ? 'is-success' : 'is-light';
                    html += `<tr>
                        <td>${a.platform}</td>
                        <td>${a.product}</td>
                        <td>$${a.budget}</td>
                        <td><span class="tag ${badgeClass}">${a.status}</span></td>
                        <td>${new Date(a.timestamp).toLocaleString()}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (e) { list.innerHTML = `<p class="has-text-danger">Error: ${e.message}</p>`; }
        }

        // --- Database ---
        function handleTableChange() {
            const table = document.getElementById('dbTableSelector').value;
            const topicFilter = document.getElementById('dbTopicFilter');
            if (table === 'events') {
                topicFilter.parentElement.parentElement.parentElement.style.display = 'block';
                fetchDbTopics();
            } else {
                topicFilter.parentElement.parentElement.parentElement.style.display = 'none';
            }
            fetchDbData();
        }

        async function fetchDbTopics() {
            try {
                const db = document.getElementById('dbSelector').value;
                const res = await fetch(`/api/db/topics?db=${db}`);
                const topics = await res.json();
                const select = document.getElementById('dbTopicFilter');
                const current = select.value;
                select.innerHTML = '<option value="">All Topics</option>' + topics.map(t => `<option value="${t}">${t}</option>`).join('');
                if (topics.includes(current)) select.value = current;
            } catch (e) { console.error("Error fetching topics", e); }
        }

        async function fetchDbData() {
            const list = document.getElementById('dbEventsList');
            const table = document.getElementById('dbTableSelector').value;
            const topic = document.getElementById('dbTopicFilter').value;
            const db = document.getElementById('dbSelector').value;
            
            try {
                let url = `/api/db/table/${table}?db=${db}`;
                if (table === 'events' && topic) url += `&topic=${encodeURIComponent(topic)}`;

                const res = await fetch(url);
                const data = await res.json();
                
                if (data.length === 0) { list.innerHTML = '<p class="has-text-centered has-text-grey p-4">No records found.</p>'; return; }

                let html = '<table class="table is-fullwidth is-striped is-hoverable"><thead><tr>';
                if (table === 'events') html += '<th>ID</th><th>Topic</th><th>Type</th><th>Payload</th><th>Time</th>';
                else if (table === 'products') html += '<th>ID</th><th>Name</th><th>Price</th><th>Margin</th><th>Time</th>';
                else if (table === 'orders') html += '<th>ID</th><th>Product ID</th><th>Amount</th><th>Status</th><th>Time</th>';
                else if (table === 'ads') html += '<th>ID</th><th>Platform</th><th>Product</th><th>Budget</th><th>Status</th>';
                else Object.keys(data[0]).forEach(k => html += `<th>${k}</th>`);
                html += '</tr></thead><tbody>';

                data.forEach(row => {
                    html += '<tr>';
                    if (table === 'events') {
                        html += `<td>${row.id}</td><td><span class="tag is-info">${row.topic}</span></td><td>${row.type}</td>
                            <td><pre class="is-size-7" style="max-height:100px; overflow:auto;">${JSON.stringify(row.payload, null, 2)}</pre></td>
                            <td>${new Date(row.created_at).toLocaleString()}</td>`;
                    } else if (table === 'products') {
                        html += `<td>${row.id}</td><td><strong>${row.name}</strong></td><td>$${row.price}</td><td>${row.margin}</td><td>${new Date(row.created_at).toLocaleString()}</td>`;
                    } else if (table === 'orders') {
                        html += `<td>${row.id}</td><td>${row.product_id}</td><td>$${row.amount}</td><td><span class="tag is-warning">${row.status}</span></td><td>${new Date(row.created_at).toLocaleString()}</td>`;
                    } else if (table === 'ads') {
                        html += `<td>${row.id}</td><td>${row.platform}</td><td>${row.product}</td><td>$${row.budget}</td><td>${row.status}</td>`;
                    } else {
                         Object.values(row).forEach(v => html += `<td>${typeof v === 'object' ? JSON.stringify(v) : v}</td>`);
                    }
                    html += '</tr>';
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (e) { list.innerHTML = `<p class="has-text-danger">Error fetching data: ${e.message}</p>`; }
        }

        // --- CEO Chat ---
        function handleChatKey(e) {
            if (e.key === 'Enter') sendCeoMessage();
        }

        async function sendCeoMessage() {
            const input = document.getElementById('ceoChatInput');
            const message = input.value.trim();
            if (!message) return;

            // 1. Add User Message
            appendMessage('user', message);
            input.value = '';

            // 2. Call API
            const thinkingId = appendMessage('ceo', 'Thinking...', true);
            
            try {
                const res = await fetch('/api/ceo/chat', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, mode: currentMode }) 
                });
                
                const data = await res.json();
                
                // Remove thinking bubble
                document.getElementById(thinkingId).remove();

                if (res.ok) {
                    appendMessage('ceo', data.response);
                } else {
                    appendMessage('ceo', "Error: " + (data.error || "Unknown error"));
                }

            } catch (e) {
                document.getElementById(thinkingId).remove();
                appendMessage('ceo', "Error: Unable to reach the CEO Agent.");
            }
        }

        function appendMessage(sender, text, isTemp = false) {
            const history = document.getElementById('chatHistory');
            const div = document.createElement('div');
            div.className = `chat-message ${sender}`;
            if (isTemp) div.id = 'msg-' + Date.now();
            
            const name = sender === 'user' ? 'You' : 'CEO Agent';
            div.innerHTML = `<div class="has-text-weight-bold mb-1">${name}</div>${text}`;
            
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div.id;
        }

        // --- Config ---
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                currentMode = config.mode || 'simulation';
                
                document.getElementById('dbMode').value = config.dbMode || 'test';
                document.getElementById('logLevel').value = config.logLevel;
                
                updateCeoModeBadge(currentMode);

                // Handle Initial Tab
                const hash = window.location.hash.substring(1);
                if (hash && document.getElementById(hash)) {
                    switchTab(hash);
                } else {
                    // Default tab based on mode
                    if (currentMode === 'simulation') {
                        window.location.hash = 'simulation';
                    } else {
                        window.location.hash = 'products';
                    }
                }

                // Initialize Sidebar (it will fetch config again but that's fine)
                if (window.initSidebar) window.initSidebar();

            } catch (e) { showStatus('Failed to load configuration.', 'is-danger'); }
        }

        async function saveConfig() {
            const newConfig = {
                dbMode: document.getElementById('dbMode').value,
                logLevel: document.getElementById('logLevel').value
            };
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newConfig)
                });
                if (res.ok) showStatus('Configuration saved successfully!', 'is-success');
                else showStatus('Error saving configuration.', 'is-danger');
            } catch (e) { showStatus('Network error.', 'is-danger'); }
        }

        function updateCeoModeBadge(mode) {
            const badge = document.getElementById('ceoModeBadge');
            if (badge) {
                if (mode === 'live') {
                    badge.textContent = 'CEO: Live (Azure OpenAI)';
                    badge.className = 'tag is-success';
                    badge.style.background = ''; // Reset inline styles
                    badge.style.color = '';
                } else {
                    badge.textContent = 'CEO: Mock (Simulated)';
                    badge.className = 'tag is-warning';
                    badge.style.background = '';
                    badge.style.color = '';
                }
            }
        }

        function showStatus(msg, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = 'notification ' + (type === 'success' ? 'is-success' : 'is-danger');
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // --- Docker Control ---
        async function checkDockerStatus() {
            try {
                const res = await fetch('/api/docker/status');
                const data = await res.json();
                updateDbStatus(data.running);
            } catch (e) {
                updateDbStatus(null);
            }
        }

        function updateDbStatus(running) {
            const indicator = document.getElementById('dbStatusIndicator');
            const text = document.getElementById('dbStatusText');
            
            if (running === true) {
                indicator.className = 'tag is-success mr-2';
                text.textContent = 'Running';
                text.className = 'has-text-success has-text-weight-bold';
            } else if (running === false) {
                indicator.className = 'tag is-danger mr-2';
                text.textContent = 'Stopped';
                text.className = 'has-text-danger has-text-weight-bold';
            } else {
                indicator.className = 'tag is-light mr-2';
                text.textContent = 'Unknown';
                text.className = 'has-text-grey has-text-weight-bold';
            }
        }

        async function startDocker() {
            const indicator = document.getElementById('dbStatusIndicator');
            const text = document.getElementById('dbStatusText');
            
            try {
                indicator.className = 'tag is-warning mr-2';
                text.textContent = 'Starting...';
                text.className = 'has-text-warning has-text-weight-bold';
                
                const res = await fetch('/api/docker/start', { method: 'POST' });
                const data = await res.json();
                
                if (data.status === 'success') {
                    setTimeout(checkDockerStatus, 2000);
                } else {
                    setTimeout(checkDockerStatus, 1000);
                }
            } catch (e) {
                setTimeout(checkDockerStatus, 1000);
            }
        }

        async function stopDocker() {
            const indicator = document.getElementById('dbStatusIndicator');
            const text = document.getElementById('dbStatusText');
            
            try {
                indicator.className = 'tag is-warning mr-2';
                text.textContent = 'Stopping...';
                text.className = 'has-text-warning has-text-weight-bold';
                
                const res = await fetch('/api/docker/stop', { method: 'POST' });
                const data = await res.json();
                
                if (data.status === 'success') {
                    setTimeout(checkDockerStatus, 2000);
                } else {
                    setTimeout(checkDockerStatus, 1000);
                }
            } catch (e) {
                setTimeout(checkDockerStatus, 1000);
            }
        }

        // Init
        loadConfig();
        // Initialize Sidebar explicitly
        if (window.initSidebar) window.initSidebar();

        // Handle hash changes
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1);
            if (hash && document.getElementById(hash)) {
                switchTab(hash);
                if (window.highlightSidebar) window.highlightSidebar();
            }
        });
    </script>
</body>
</html>
