<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS1 Control Panel</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>

    <!-- Sidebar -->
    <nav id="sidebar-container"></nav>

    <!-- Main Content -->
    <main class="main">
        <div id="statusMessage" class="status-msg"></div>

        <!-- SIMULATION -->
        <div id="simulation" class="tab-content">
            <div class="page-header">
                <h1 class="page-title">Simulation Control</h1>
            </div>
            <div class="card">
                <h2>Run Simulation</h2>
                <p style="margin-bottom: 1.5rem; color: #6b7280;">Trigger a full end-to-end product lifecycle simulation: Research -> Sourcing -> Store -> Ads -> Sales.</p>
                <div style="display: flex; gap: 10px;">
                    <button onclick="startSimulation()">â–¶ Start New Simulation</button>
                    <button class="secondary" onclick="clearLogDisplay()">ðŸ§¹ Clear Logs</button>
                    <button class="secondary" onclick="showAllLogs()">ðŸ“œ Show History</button>
                </div>
            </div>
            
            <div class="card" style="height: calc(100vh - 350px); display: flex; flex-direction: column;">
                <h2 style="margin-bottom: 0.5rem; border: none;">Live Agent Logs</h2>
                <div id="logViewer">Waiting for logs...</div>
            </div>
        </div>

        <!-- PRODUCTS -->
        <div id="products" class="tab-content hidden">
            <div class="page-header">
                <h1 class="page-title">Winning Products</h1>
                <button onclick="fetchProducts()">ðŸ”„ Refresh</button>
            </div>
            <div class="card">
                <div id="productsList" class="table-container">Loading...</div>
            </div>
        </div>

        <!-- ORDERS -->
        <div id="orders" class="tab-content hidden">
            <div class="page-header">
                <h1 class="page-title">Order History</h1>
                <button onclick="fetchOrders()">ðŸ”„ Refresh</button>
            </div>
            <div class="card">
                <div id="ordersList" class="table-container">Loading...</div>
            </div>
        </div>

        <!-- ADS -->
        <div id="ads" class="tab-content hidden">
            <div class="page-header">
                <h1 class="page-title">Ad Campaigns</h1>
                <button onclick="fetchAds()">ðŸ”„ Refresh</button>
            </div>
            <div class="card">
                <div id="adsList" class="table-container">
                    <p style="color: #6b7280; text-align: center; padding: 2rem;">No active ad campaigns found.</p>
                </div>
            </div>
        </div>

        <!-- SETTINGS -->
        <div id="settings" class="tab-content hidden">
            <div class="page-header">
                <h1 class="page-title">System Settings</h1>
            </div>
            <div class="card" style="max-width: 600px;">
                <h2>Environment Configuration</h2>
                
                <label for="dbMode">Database Mode</label>
                <select id="dbMode">
                    <option value="mock">Mock (Sandbox)</option>
                    <option value="live">Live (Azure Cosmos DB)</option>
                </select>
                <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 1.5rem;">Switching modes will reconnect the database immediately.</p>

                <label for="logLevel">Log Level</label>
                <select id="logLevel">
                    <option value="debug">Debug (Verbose)</option>
                    <option value="info">Info (Standard)</option>
                    <option value="warn">Warning</option>
                    <option value="error">Error Only</option>
                </select>

                <label for="useSimulatedEndpoints">3rd Party Integrations</label>
                <select id="useSimulatedEndpoints">
                    <option value="true">Simulated (Mock APIs)</option>
                    <option value="false">Real (Live APIs)</option>
                </select>

                <div style="margin-top: 2rem;">
                    <button onclick="saveConfig()">ðŸ’¾ Save & Apply Changes</button>
                </div>
            </div>
        </div>

        <!-- DATABASE -->
        <div id="database" class="tab-content hidden">
            <div class="page-header">
                <h1 class="page-title">Database Inspector</h1>
            </div>
            <div class="card">
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label>Source</label>
                        <select id="dbSelector" onchange="fetchDbTopics(); fetchDbData()" style="margin-bottom: 0;">
                            <option value="live">Live Database</option>
                            <option value="sim">Simulator Database</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label>Table</label>
                        <select id="dbTableSelector" onchange="handleTableChange()" style="margin-bottom: 0;">
                            <option value="events">Events</option>
                            <option value="products">Products</option>
                            <option value="orders">Orders</option>
                            <option value="ads">Ads</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label>Topic Filter</label>
                        <select id="dbTopicFilter" onchange="fetchDbData()" style="margin-bottom: 0;">
                            <option value="">All Topics</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button onclick="fetchDbData()" style="height: 42px;">ðŸ”„ Refresh Data</button>
                    </div>
                </div>
                <div id="dbEventsList" class="table-container">Loading...</div>
            </div>
        </div>

    </main>

    <script>
        let logInterval = null;
        let logStartTime = 0;

        // --- Navigation ---
        function switchTab(tabId) {
            // Update Content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            const tab = document.getElementById(tabId);
            if (tab) {
                tab.classList.remove('hidden');
            }

            // Handle Simulation Logs
            if (tabId === 'simulation') {
                fetchLogs();
                if (!logInterval) logInterval = setInterval(fetchLogs, 2000);
            } else {
                if (logInterval) {
                    clearInterval(logInterval);
                    logInterval = null;
                }
            }

            // Auto-refresh data
            if (tabId === 'products') fetchProducts();
            if (tabId === 'orders') fetchOrders();
            if (tabId === 'ads') fetchAds();
            if (tabId === 'database') { fetchDbTopics(); fetchDbData(); }
        }

        // Handle initial hash
        window.addEventListener('load', () => {
            const hash = window.location.hash.substring(1);
            if (hash && document.getElementById(hash)) {
                switchTab(hash);
            } else {
                switchTab('simulation');
            }
        });

        // --- Simulation & Logs ---
        function clearLogDisplay() {
            logStartTime = Date.now();
            fetchLogs();
            showStatus('Log display cleared.', 'success');
        }

        function showAllLogs() {
            logStartTime = 0;
            fetchLogs();
            showStatus('Showing full history.', 'success');
        }

        async function startSimulation() {
            try {
                logStartTime = Date.now() - 2000;
                const res = await fetch('/api/simulation/start', { method: 'POST' });
                const data = await res.json();
                showStatus(data.message, 'success');
                fetchLogs();
            } catch (e) {
                showStatus('Failed to start simulation.', 'error');
            }
        }

        async function fetchLogs() {
            try {
                const res = await fetch('/api/logs');
                const logs = await res.json();
                const filteredLogs = logs.filter(log => new Date(log.timestamp).getTime() >= logStartTime);
                const viewer = document.getElementById('logViewer');
                
                if (filteredLogs.length === 0) {
                    viewer.innerHTML = `<div style="padding:1rem; color: #666;">No new logs...</div>`;
                    return;
                }

                viewer.innerHTML = filteredLogs.map(log => `
                    <div class="log-entry">
                        <span class="log-time">[${new Date(log.timestamp).toLocaleTimeString()}]</span>
                        <span class="log-agent">${log.agent}</span>
                        <span class="log-msg">${log.message}</span>
                        ${log.data ? `<pre style="font-size:0.8em; color:#9cdcfe; margin-top:0.2rem;">${JSON.stringify(log.data, null, 2)}</pre>` : ''}
                    </div>
                `).join('');
                
                // Auto scroll to bottom
                viewer.scrollTop = viewer.scrollHeight;
            } catch (e) { console.error("Log fetch failed", e); }
        }

        // --- Data Fetching ---
        async function fetchProducts() {
            const list = document.getElementById('productsList');
            try {
                const res = await fetch('/api/products');
                const products = await res.json();
                if (products.length === 0) { list.innerHTML = '<p style="padding:1rem">No products found.</p>'; return; }

                let html = `<table><thead><tr><th>Name</th><th>Potential</th><th>Margin</th><th>Found At</th></tr></thead><tbody>`;
                products.forEach(p => {
                    html += `<tr>
                        <td><strong>${p.name}</strong></td>
                        <td><span class="badge badge-green">${p.potential}</span></td>
                        <td>${p.margin}</td>
                        <td>${new Date(p.timestamp).toLocaleString()}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (e) { list.innerHTML = `<p class="error">Error: ${e.message}</p>`; }
        }

        async function fetchOrders() {
            const list = document.getElementById('ordersList');
            try {
                const res = await fetch('/api/orders');
                const orders = await res.json();
                if (orders.length === 0) { list.innerHTML = '<p style="padding:1rem">No orders found.</p>'; return; }

                let html = `<table><thead><tr><th>Order ID</th><th>Product</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead><tbody>`;
                orders.forEach(o => {
                    const badgeClass = o.status === 'shipped' ? 'badge-blue' : 'badge-yellow';
                    html += `<tr>
                        <td>${o.id}</td>
                        <td>${o.product}</td>
                        <td>$${o.amount}</td>
                        <td><span class="badge ${badgeClass}">${o.status}</span></td>
                        <td>${new Date(o.timestamp).toLocaleString()}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (e) { list.innerHTML = `<p class="error">Error: ${e.message}</p>`; }
        }

        async function fetchAds() {
             // Placeholder for Ads fetching logic
             const list = document.getElementById('adsList');
             // For now, just show empty state or mock data if available
             // list.innerHTML = ...
        }

        // --- Database ---
        function handleTableChange() {
            const table = document.getElementById('dbTableSelector').value;
            const topicFilter = document.getElementById('dbTopicFilter');
            if (table === 'events') {
                topicFilter.parentElement.style.display = 'block';
                fetchDbTopics();
            } else {
                topicFilter.parentElement.style.display = 'none';
            }
            fetchDbData();
        }

        async function fetchDbTopics() {
            try {
                const db = document.getElementById('dbSelector').value;
                const res = await fetch(`/api/db/topics?db=${db}`);
                const topics = await res.json();
                const select = document.getElementById('dbTopicFilter');
                const current = select.value;
                select.innerHTML = '<option value="">All Topics</option>' + topics.map(t => `<option value="${t}">${t}</option>`).join('');
                if (topics.includes(current)) select.value = current;
            } catch (e) { console.error("Error fetching topics", e); }
        }

        async function fetchDbData() {
            const list = document.getElementById('dbEventsList');
            const table = document.getElementById('dbTableSelector').value;
            const topic = document.getElementById('dbTopicFilter').value;
            const db = document.getElementById('dbSelector').value;
            
            try {
                let url = `/api/db/table/${table}?db=${db}`;
                if (table === 'events' && topic) url += `&topic=${encodeURIComponent(topic)}`;

                const res = await fetch(url);
                const data = await res.json();
                
                if (data.length === 0) { list.innerHTML = '<p style="padding:1rem">No records found.</p>'; return; }

                let html = '<table><thead><tr>';
                if (table === 'events') html += '<th>ID</th><th>Topic</th><th>Type</th><th>Payload</th><th>Time</th>';
                else if (table === 'products') html += '<th>ID</th><th>Name</th><th>Price</th><th>Margin</th><th>Time</th>';
                else if (table === 'orders') html += '<th>ID</th><th>Product ID</th><th>Amount</th><th>Status</th><th>Time</th>';
                else if (table === 'ads') html += '<th>ID</th><th>Platform</th><th>Product</th><th>Budget</th><th>Status</th>';
                else Object.keys(data[0]).forEach(k => html += `<th>${k}</th>`);
                html += '</tr></thead><tbody>';

                data.forEach(row => {
                    html += '<tr>';
                    if (table === 'events') {
                        html += `<td>${row.id}</td><td><span class="badge badge-blue">${row.topic}</span></td><td>${row.type}</td>
                            <td><pre style="font-size:0.8em; margin:0; max-height:100px; overflow:auto;">${JSON.stringify(row.payload, null, 2)}</pre></td>
                            <td>${new Date(row.created_at).toLocaleString()}</td>`;
                    } else if (table === 'products') {
                        html += `<td>${row.id}</td><td><strong>${row.name}</strong></td><td>$${row.price}</td><td>${row.margin}</td><td>${new Date(row.created_at).toLocaleString()}</td>`;
                    } else if (table === 'orders') {
                        html += `<td>${row.id}</td><td>${row.product_id}</td><td>$${row.amount}</td><td><span class="badge badge-yellow">${row.status}</span></td><td>${new Date(row.created_at).toLocaleString()}</td>`;
                    } else if (table === 'ads') {
                        html += `<td>${row.id}</td><td>${row.platform}</td><td>${row.product}</td><td>$${row.budget}</td><td>${row.status}</td>`;
                    } else {
                         Object.values(row).forEach(v => html += `<td>${typeof v === 'object' ? JSON.stringify(v) : v}</td>`);
                    }
                    html += '</tr>';
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (e) { list.innerHTML = `<p class="error">Error fetching data: ${e.message}</p>`; }
        }

        // --- Config ---
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                document.getElementById('dbMode').value = config.dbMode;
                document.getElementById('logLevel').value = config.logLevel;
                document.getElementById('useSimulatedEndpoints').value = config.useSimulatedEndpoints.toString();
            } catch (e) { showStatus('Failed to load configuration.', 'status-error'); }
        }

        async function saveConfig() {
            const newConfig = {
                dbMode: document.getElementById('dbMode').value,
                logLevel: document.getElementById('logLevel').value,
                useSimulatedEndpoints: document.getElementById('useSimulatedEndpoints').value === 'true'
            };
            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newConfig)
                });
                if (res.ok) showStatus('Configuration saved successfully!', 'status-success');
                else showStatus('Error saving configuration.', 'status-error');
            } catch (e) { showStatus('Network error.', 'status-error'); }
        }

        function showStatus(msg, type) {
            const el = document.getElementById('statusMessage');
            el.textContent = msg;
            el.className = 'status-msg ' + type;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // Init
        loadConfig();
        // Handle hash changes
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.substring(1);
            if (hash && document.getElementById(hash)) {
                switchTab(hash);
            }
        });
    </script>
    <script src="sidebar.js"></script>
</body>
</html>