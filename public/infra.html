<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS1 Infrastructure Manager</title>
    <link rel="stylesheet" href="css/bulma.css">
    <link rel="stylesheet" href="css/overrides.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom row styling for modes */
        tr.mode-mock td:nth-child(2) .select select { background-color: #fef3c7; color: #92400e; border-color: #fcd34d; } /* Yellow/Amber */
        tr.mode-simulation td:nth-child(2) .select select { background-color: #eff6ff; color: #1e40af; border-color: #60a5fa; } /* Blue */
        tr.mode-live td:nth-child(2) .select select { background-color: #fef2f2; color: #991b1b; border-color: #f87171; } /* Red */
        
        /* Indicator strip */
        tr.mode-mock td:first-child { border-left: 4px solid #f59e0b; }
        tr.mode-simulation td:first-child { border-left: 4px solid #3b82f6; }
        tr.mode-live td:first-child { border-left: 4px solid #ef4444; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav id="sidebar-container"></nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="level mb-5">
            <div class="level-left">
                <div class="level-item">
                    <div>
                        <h1 class="title is-3">Infrastructure Configuration</h1>
                        <p class="subtitle is-6 has-text-grey">Manage external service connections and simulation modes</p>
                    </div>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <span class="tag is-warning is-medium">Restart Required on Change</span>
                </div>
            </div>
        </div>

        <div class="notification is-warning is-light">
            <button class="delete"></button>
            <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>
            <strong>Note:</strong> Changing infrastructure modes requires a server restart to take effect.
        </div>

        <div id="statusMsg" class="notification is-hidden"></div>

        <div class="card">
            <div class="card-content">
                <form id="configForm">
                    <div class="table-container">
                        <table class="table is-fullwidth is-hoverable">
                            <thead>
                                <tr>
                                    <th style="width: 25%">Service / Component</th>
                                    <th style="width: 30%">Configuration Mode</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody id="configTableBody">
                                <!-- Dynamic Content -->
                            </tbody>
                        </table>
                    </div>

                    <div class="field is-grouped is-grouped-right mt-5">
                        <div class="control">
                            <button type="button" class="button is-primary" onclick="saveConfig()" disabled title="Configuration updates via UI are currently read-only">
                                <span class="icon is-small">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <span>Save Configuration (Edit YAML to change)</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="sidebar.js"></script>
    <script>
        const services = [
            { id: 'ceo', name: 'CEO Agent', desc: 'Executive decision making and team coordination.' },
            { id: 'trends', name: 'Product Research (Trends)', desc: 'Market trend analysis and product discovery (Google Trends).' },
            { id: 'competitor', name: 'Competitor Analysis', desc: 'Competitor store tracking and price monitoring.' },
            { id: 'fulfilment', name: 'Supplier Network', desc: 'Product sourcing, inventory, and order fulfillment.' },
            { id: 'shop', name: 'Shop Platform', desc: 'E-commerce store management (Shopify).' },
            { id: 'ads', name: 'Advertising Platform', desc: 'Ad campaign management (Facebook/TikTok Ads).' },
            { id: 'email', name: 'Customer Service (Email)', desc: 'Customer support and email communication.' },
            { id: 'operations', name: 'Operations', desc: 'Daily business operations and order processing.' },
            { id: 'analytics', name: 'Analytics', desc: 'Business performance reporting and insights.' },
            { id: 'ai', name: 'AI Core Services', desc: 'Underlying LLM and cognitive services.' }
        ];

        // Load Config
        async function loadConfig() {
            const tbody = document.getElementById('configTableBody');
            tbody.innerHTML = '<tr><td colspan="3" class="has-text-centered p-4"><span class="icon"><i class="fas fa-spinner fa-pulse"></i></span> Loading configuration...</td></tr>';

            try {
                const res = await fetch('/api/config');
                if (!res.ok) throw new Error("Failed to fetch config");
                
                const fullConfig = await res.json();
                const serviceConfig = fullConfig.bootstrap?.services || {};
                
                tbody.innerHTML = services.map(service => {
                    const currentMode = serviceConfig[service.id] || 'mock';
                    return `
                        <tr class="config-row mode-${currentMode}" id="row-${service.id}">
                            <td><strong>${service.name}</strong></td>
                            <td>
                                <div class="control">
                                    <div class="select is-fullwidth">
                                        <select id="${service.id}Mode" name="${service.id}" onchange="updateRowStyle(this)" disabled>
                                            <option value="mock" ${currentMode === 'mock' ? 'selected' : ''}>Mock (Fake Data)</option>
                                            <option value="simulation" ${currentMode === 'simulation' ? 'selected' : ''}>Simulation (System Logic)</option>
                                            <option value="live" ${currentMode === 'live' ? 'selected' : ''}>Live (Real API Calls)</option>
                                        </select>
                                    </div>
                                </div>
                            </td>
                            <td>${service.desc}</td>
                        </tr>
                    `;
                }).join('');

            } catch (e) {
                showStatus('Failed to load configuration: ' + e.message, 'error');
                tbody.innerHTML = `<tr><td colspan="3" class="has-text-danger has-text-centered">Error loading configuration: ${e.message}</td></tr>`;
                console.error(e);
            }
        }

        function updateRowStyle(selectElement) {
            const row = selectElement.closest('tr');
            row.classList.remove('mode-mock', 'mode-simulation', 'mode-live');
            row.classList.add('mode-' + selectElement.value);
        }

        function showStatus(msg, type) {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = 'notification ' + (type === 'success' ? 'is-success' : 'is-danger');
            el.classList.remove('is-hidden');
            setTimeout(() => el.classList.add('is-hidden'), 5000);
        }

        // Init
        loadConfig();
        if (window.initSidebar) window.initSidebar();
    </script>
</body>
</html>
