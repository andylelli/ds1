<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS1 Infrastructure Manager</title>
    <link rel="stylesheet" href="admin.css">
    <style>
        .config-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .config-table th, .config-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .config-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: var(--text-color);
        }
        .config-table tr:last-child td {
            border-bottom: none;
        }
        
        /* Mode Colors */
        tr.mode-mock td:nth-child(2) { background-color: #f3f4f6; color: #4b5563; }
        tr.mode-test td:nth-child(2) { background-color: #fffbeb; color: #92400e; }
        tr.mode-live td:nth-child(2) { background-color: #ecfdf5; color: #065f46; }
        
        /* Indicator strip */
        tr.mode-mock td:first-child { border-left: 4px solid #9ca3af; }
        tr.mode-test td:first-child { border-left: 4px solid #f59e0b; }
        tr.mode-live td:first-child { border-left: 4px solid #10b981; }

        select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: white;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav id="sidebar-container"></nav>

    <!-- Main Content -->
    <div class="main" style="padding-bottom: 5rem;">
        <div class="page-header">
            <h1 class="page-title">Infrastructure Configuration</h1>
            <div class="badge badge-yellow">Restart Required on Change</div>
        </div>

        <div class="warning-box">
            <span>‚ö†Ô∏è</span>
            <span><strong>Note:</strong> Changing infrastructure modes requires a server restart to take effect.</span>
        </div>

        <div id="statusMsg" class="status-msg"></div>

        <form id="configForm">
            <table class="config-table">
                <thead>
                    <tr>
                        <th style="width: 25%">Component</th>
                        <th style="width: 30%">Configuration Mode</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Shop -->
                    <tr class="config-row">
                        <td><strong>Shop Platform</strong></td>
                        <td>
                            <select id="shopMode" name="shopMode">
                                <option value="mock">Mock (Local Simulation)</option>
                                <option value="test">Test (Shopify Dev Store)</option>
                                <option value="live">Live (Real Shopify Store)</option>
                            </select>
                        </td>
                        <td>Controls where products are created and orders are fetched from.</td>
                    </tr>

                    <!-- Ads -->
                    <tr class="config-row">
                        <td><strong>Advertising Platform</strong></td>
                        <td>
                            <select id="adsMode" name="adsMode">
                                <option value="mock">Mock (Local Simulation)</option>
                                <option value="test">Test (Sandbox APIs)</option>
                                <option value="live">Live (Real Ad Spend)</option>
                            </select>
                        </td>
                        <td>Controls where ad campaigns are deployed.</td>
                    </tr>

                    <!-- Trends -->
                    <tr class="config-row">
                        <td><strong>Market Trends</strong></td>
                        <td>
                            <select id="trendsMode" name="trendsMode">
                                <option value="mock">Mock (Static Data)</option>
                                <option value="live">Live (Google Trends/AI)</option>
                            </select>
                        </td>
                        <td>Source of viral trend data.</td>
                    </tr>

                    <!-- Research -->
                    <tr class="config-row">
                        <td><strong>Competitor Analysis</strong></td>
                        <td>
                            <select id="researchMode" name="researchMode">
                                <option value="mock">Mock (Static Data)</option>
                                <option value="live">Live (Ad Spy/Scraping)</option>
                            </select>
                        </td>
                        <td>Source of competitor intelligence.</td>
                    </tr>

                    <!-- Fulfilment -->
                    <tr class="config-row">
                        <td><strong>Fulfilment</strong></td>
                        <td>
                            <select id="fulfilmentMode" name="fulfilmentMode">
                                <option value="mock">Mock (Instant)</option>
                                <option value="live">Live (AliExpress/CJ)</option>
                            </select>
                        </td>
                        <td>How orders are fulfilled with suppliers.</td>
                    </tr>

                    <!-- Email -->
                    <tr class="config-row">
                        <td><strong>Email System</strong></td>
                        <td>
                            <select id="emailMode" name="emailMode">
                                <option value="mock">Mock (Console Log)</option>
                                <option value="live">Live (SMTP/SendGrid)</option>
                            </select>
                        </td>
                        <td>How customer emails are sent and received.</td>
                    </tr>

                    <!-- CEO -->
                    <tr class="config-row">
                        <td><strong>CEO Agent Mode</strong></td>
                        <td>
                            <select id="ceoMode" name="ceoMode">
                                <option value="mock">Mock (Scripted Responses)</option>
                                <option value="live">Live (OpenAI LLM)</option>
                            </select>
                        </td>
                        <td>Controls the intelligence level of the CEO Chat.</td>
                    </tr>

                    <!-- Logging -->
                    <tr class="config-row">
                        <td><strong>Logging Output</strong></td>
                        <td>
                            <select id="loggingMode" name="loggingMode">
                                <option value="console">Console (Standard Output)</option>
                                <option value="file">File (logs/app.log)</option>
                            </select>
                        </td>
                        <td>Where agent logs are written.</td>
                    </tr>

                    <!-- Traffic -->
                    <tr class="config-row">
                        <td><strong>Traffic Scale</strong></td>
                        <td>
                            <select id="trafficScale" name="trafficScale">
                                <option value="0.1">Low (10%)</option>
                                <option value="0.5">Medium (50%)</option>
                                <option value="1.0">Full (100%)</option>
                            </select>
                        </td>
                        <td>Volume of simulated traffic.</td>
                    </tr>
                </tbody>
            </table>

            <div class="save-bar" style="margin-top: 2rem;">
                <span style="color: #6b7280; font-size: 0.9rem;">Changes will apply after restart</span>
                <button type="submit">üíæ Save Configuration</button>
            </div>
        </form>
    </div>

    <script>
        const form = document.getElementById('configForm');

        function updateRowColor(select) {
            const row = select.closest('tr');
            const val = select.value;
            
            // Remove existing mode classes
            row.classList.remove('mode-mock', 'mode-test', 'mode-live');
            
            // Add new class based on value
            if (val === 'mock' || val === 'console' || val === '0.1') {
                row.classList.add('mode-mock');
            } else if (val === 'test' || val === '0.5') {
                row.classList.add('mode-test');
            } else if (val === 'live' || val === 'file' || val === '1.0') {
                row.classList.add('mode-live');
            }
        }

        function showStatus(msg, type = 'success') {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = 'status-msg ' + (type === 'success' ? 'status-success' : 'status-error');
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
            }, 3000);
        }

        // Load current config
        async function loadConfig() {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                
                // Populate fields
                const fields = ['shopMode', 'adsMode', 'trendsMode', 'researchMode', 'fulfilmentMode', 'emailMode', 'loggingMode', 'trafficScale', 'ceoMode'];
                fields.forEach(field => {
                    const el = document.getElementById(field);
                    if (el && config[field]) {
                        el.value = config[field];
                        updateRowColor(el); // Update color on load
                    }
                });
            } catch (err) {
                console.error('Failed to load config', err);
                showStatus('Failed to load configuration.', 'error');
            }
        }

        // Add event listeners for color updates
        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', () => updateRowColor(select));
        });

        // Save config
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {};
            
            const selects = form.querySelectorAll('select');
            selects.forEach(select => {
                data[select.name] = select.value;
            });

            if (data.trafficScale) data.trafficScale = parseFloat(data.trafficScale);

            try {
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    showStatus('Configuration saved successfully! Please restart the server.', 'success');
                } else {
                    showStatus('Failed to save configuration.', 'error');
                }
            } catch (err) {
                console.error('Failed to save config', err);
                showStatus('Error saving configuration.', 'error');
            }
        });

        loadConfig();
    </script>
    <script src="sidebar.js"></script>
</body>
</html>
