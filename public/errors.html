<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS1 Error Log</title>
    <link rel="stylesheet" href="css/bulma.css">
    <link rel="stylesheet" href="css/overrides.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar -->
    <nav id="sidebar-container"></nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="level mb-5">
            <div class="level-left">
                <div class="level-item">
                    <div>
                        <h1 class="title is-3 has-text-danger">System Error Log</h1>
                        <p class="subtitle is-6 has-text-grey">Monitoring system failures and warnings</p>
                    </div>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <div class="buttons">
                        <button class="button is-small is-danger is-light" onclick="clearErrorLogs()">
                            <span class="icon"><i class="fas fa-trash"></i></span>
                            <span>Clear</span>
                        </button>
                        <button class="button is-small is-light" onclick="fetchLogs()">
                            <span class="icon"><i class="fas fa-sync"></i></span>
                            <span>Refresh</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-content">
                <div id="errorLogContainer">
                    <div class="has-text-centered py-5">
                        <span class="icon is-large"><i class="fas fa-spinner fa-pulse fa-2x"></i></span>
                        <p class="mt-2">Loading error logs...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="sidebar.js"></script>
    <script>
        async function clearErrorLogs() {
            if(!confirm('Clear all error logs?')) return;
            try {
                await fetch('/api/logs/clear', { method: 'POST' });
                fetchLogs();
            } catch(e) {
                alert('Failed to clear logs');
            }
        }

        async function fetchLogs() {
            const btn = document.querySelector('button[onclick="fetchLogs()"]');
            if(btn) btn.classList.add('is-loading');
            
            try {
                const res = await fetch('/api/logs/errors?t=' + Date.now());
                if (!res.ok) throw new Error("Failed to fetch logs");
                const logs = await res.json();
                renderLogs(logs);
            } catch (e) {
                console.error("Failed to fetch error logs", e);
                document.getElementById('errorLogContainer').innerHTML = `
                    <div class="notification is-danger">
                        <span class="icon"><i class="fas fa-exclamation-circle"></i></span>
                        Failed to load error logs: ${e.message}
                    </div>
                `;
            } finally {
                if(btn) btn.classList.remove('is-loading');
            }
        }

        function renderLogs(logs) {
            const container = document.getElementById('errorLogContainer');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="notification is-success is-light">
                        <span class="icon"><i class="fas fa-check-circle"></i></span>
                        No errors or warnings found in the recent logs. System is healthy!
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table class="table is-fullwidth is-striped is-hoverable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Level</th>
                                <th>Agent</th>
                                <th>Action</th>
                                <th>Message</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${logs.map(log => `
                                <tr>
                                    <td class="is-size-7" style="white-space: nowrap;">
                                        ${new Date(log.timestamp).toLocaleString()}
                                    </td>
                                    <td>
                                        <span class="tag ${log.status === 'failed' ? 'is-danger' : 'is-warning'}">
                                            ${log.status.toUpperCase()}
                                        </span>
                                    </td>
                                    <td><strong>${log.agent}</strong></td>
                                    <td>${log.action}</td>
                                    <td>${log.message}</td>
                                    <td>
                                        ${log.details && log.details.error ? `<div class="has-text-danger is-size-7 mb-1" style="word-wrap: break-word;"><strong>Error:</strong> ${log.details.error}</div>` : ''}
                                        ${log.details ? `
                                            <details>
                                                <summary class="button is-small is-ghost p-0" style="height: auto; text-decoration: none;">
                                                    <span class="icon is-small"><i class="fas fa-code"></i></span>
                                                    <span>Full Details</span>
                                                </summary>
                                                <div class="mt-2">
                                                    ${log.details.stack ? `
                                                        <div class="mb-2">
                                                            <strong class="is-size-7">Stack Trace:</strong>
                                                            <pre class="is-size-7 p-2 has-background-white-ter has-text-danger-dark" style="white-space: pre-wrap; max-height: 200px; overflow: auto; border: 1px solid #f14668; border-radius: 4px;">${log.details.stack}</pre>
                                                        </div>
                                                    ` : ''}
                                                    <strong class="is-size-7">JSON Payload:</strong>
                                                    <pre class="is-size-7 p-2 has-background-white-ter" style="white-space: pre-wrap; max-height: 400px; overflow: auto; min-width: 300px; max-width: 800px; border: 1px solid #dbdbdb; border-radius: 4px;">${JSON.stringify(log.details, null, 2)}</pre>
                                                </div>
                                            </details>
                                        ` : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Initial Load
        fetchLogs();
        // Poll every 10 seconds
        setInterval(fetchLogs, 10000);

        // Initialize Sidebar
        if (window.initSidebar) window.initSidebar();
    </script>
</body>
</html>
