<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DS1 Mock Shop</title>
    <link rel="stylesheet" href="css/bulma.css">
    <link rel="stylesheet" href="css/overrides.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .product-image-container {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f5f5f5;
            font-size: 3rem;
            overflow: hidden;
        }
        .product-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav id="sidebar-container"></nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="level mb-5">
            <div class="level-left">
                <div class="level-item">
                    <div>
                        <h1 class="title is-3">Product Catalog</h1>
                        <p class="subtitle is-6 has-text-grey">Live preview of the mock storefront</p>
                    </div>
                </div>
            </div>
            <div class="level-right">
                <div class="level-item">
                    <span class="tag is-info is-medium">Live Preview</span>
                </div>
            </div>
        </div>

        <div id="productGrid" class="columns is-multiline">
            <!-- Products will be injected here -->
            <div class="column is-full">
                <div class="box has-text-centered py-6">
                    <p class="has-text-grey">Loading products...</p>
                </div>
            </div>
        </div>
    </main>

    <div id="statusMsg" class="notification is-hidden" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;"></div>

    <script src="sidebar.js"></script>
    <script>
        function showStatus(msg, type = 'success') {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = 'notification ' + (type === 'success' ? 'is-success' : 'is-danger');
            el.classList.remove('is-hidden');
            setTimeout(() => {
                el.classList.add('is-hidden');
            }, 3000);
        }

        async function loadProducts() {
            const grid = document.getElementById('productGrid');
            try {
                const res = await fetch('/api/products');
                const products = await res.json();

                if (products.length === 0) {
                    grid.innerHTML = `
                        <div class="column is-full">
                            <div class="box has-text-centered py-6">
                                <p class="title is-4 has-text-grey mb-4">No products available.</p>
                                <a href="admin.html" class="button is-primary">
                                    <span>Run a simulation in the Control Panel</span>
                                    <span class="icon is-small"><i class="fas fa-arrow-right"></i></span>
                                </a>
                            </div>
                        </div>
                    `;
                    return;
                }

                grid.innerHTML = products.map(p => {
                    const imgUrl = (p.images && p.images.length > 0) ? p.images[0] : null;
                    const imgTag = imgUrl 
                        ? `<img src="${imgUrl}" alt="${p.name}">` 
                        : `<span class="icon is-large has-text-grey-light"><i class="fas fa-box-open fa-3x"></i></span>`;
                    
                    const price = p.price || 49.99; 

                    return `
                    <div class="column is-one-third-desktop is-half-tablet">
                        <div class="card h-100">
                            <div class="card-image">
                                <figure class="image is-4by3 product-image-container">
                                    ${imgTag}
                                </figure>
                            </div>
                            <div class="card-content">
                                <div class="media">
                                    <div class="media-content">
                                        <p class="title is-5">${p.name}</p>
                                        <p class="subtitle is-6 has-text-primary has-text-weight-bold">$${price}</p>
                                    </div>
                                </div>

                                <div class="content is-small">
                                    <div class="tags are-small">
                                        <span class="tag is-light">Potential: ${p.potential}</span>
                                        <span class="tag is-light">Margin: ${p.margin}</span>
                                    </div>
                                </div>
                                
                                <button class="button is-primary is-fullwidth" onclick="buyProduct('${p.name}', ${price})">
                                    <span class="icon is-small"><i class="fas fa-shopping-cart"></i></span>
                                    <span>Buy Now</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');

            } catch (e) {
                grid.innerHTML = `<div class="column is-full"><div class="notification is-danger">Error loading products: ${e.message}</div></div>`;
            }
        }

        async function buyProduct(name, price) {
            try {
                const res = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ product: name, amount: price })
                });
                
                if (res.ok) {
                    showStatus(`Order placed for ${name}!`, 'success');
                } else {
                    showStatus('Failed to place order.', 'error');
                }
            } catch (e) {
                showStatus('Error placing order.', 'error');
            }
        }

        // Init
        loadProducts();
        if (window.initSidebar) window.initSidebar();
    </script>
</body>
</html>